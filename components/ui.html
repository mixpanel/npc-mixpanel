<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport"
		content="width=device-width, initial-scale=1.0">
	<title>Mixpanel Simulator</title>
	<style>
		:root {
			--bg-color: #1a1a1a;
			--text-color: #f9fafb;
			--primary-color: #9d5cff;
			--secondary-color: #4a1e8a;
			--third-color: #FF7557;
			--fourth-color: #80E1D9;
			--input-bg: #2c2c2c;
			--input-border: #3f3f3f;
		}

		body {
			font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
			background-color: var(--bg-color);
			color: var(--text-color);
			line-height: 1.5;
			margin: 0;
			padding: 0;
			display: flex;
			flex-direction: column;
			min-height: 100vh;
		}

		.title-bar {
			background-color: var(--secondary-color);
			padding: 1rem;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		.logo {
			width: 40px;
			height: 40px;
			margin-right: 1rem;
		}

		.title {
			font-size: 1.5rem;
			font-weight: 600;
			color: var(--text-color);
		}

		a {
			color: var(--third-color);
		}

		a:hover {
			color: var(--fourth-color);
		}

		a:visited {
			color: var(--secondary-color);
		}

		.container {
			flex-grow: 1;
			display: flex;
			justify-content: center;
			align-items: center;
			padding: 2rem;
		}

		.form-container {
			background-color: #2a2a2a;
			border-radius: 8px;
			box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
			padding: 2rem;
			width: 100%;
			max-width: 400px;
		}

		h1 {
			font-size: 1.25rem;
			font-weight: 600;
			margin-bottom: 1.5rem;
			text-align: center;
			color: var(--primary-color);
		}

		form {
			display: flex;
			flex-direction: column;
			gap: 1rem;
		}

		label {
			font-weight: 500;
			margin-bottom: 0.25rem;
		}

		input[type="text"],
		input[type="range"] {
			width: 100%;
			padding: 0.5rem;
			background-color: var(--input-bg);
			border: 1px solid var(--input-border);
			border-radius: 4px;
			font-size: 1rem;
			color: var(--text-color);
		}

		input[type="range"] {
			-webkit-appearance: none;
			appearance: none;
			height: 8px;
			background: var(--input-border);
			outline: none;
			opacity: 0.7;
			transition: opacity 0.2s;
		}

		input[type="range"]:hover {
			opacity: 1;
		}

		input[type="range"]::-webkit-slider-thumb {
			-webkit-appearance: none;
			appearance: none;
			width: 20px;
			height: 20px;
			background: var(--primary-color);
			cursor: pointer;
			border-radius: 50%;
		}

		input[type="range"]::-moz-range-thumb {
			width: 20px;
			height: 20px;
			background: var(--primary-color);
			cursor: pointer;
			border-radius: 50%;
		}

		button {
			background-color: var(--primary-color);
			color: var(--text-color);
			border: none;
			border-radius: 4px;
			padding: 0.75rem 1rem;
			font-size: 1rem;
			font-weight: 600;
			cursor: pointer;
			transition: background-color 0.2s;
		}

		button:hover {
			background-color: var(--secondary-color);
		}

		.loading,
		.success {
			display: none;
			text-align: center;
			font-size: 1.25rem;
			font-weight: 500;
		}

		.loading::after {
			content: '';
			display: inline-block;
			width: 1em;
			height: 1em;
			border: 2px solid var(--primary-color);
			border-top: 2px solid transparent;
			border-radius: 50%;
			animation: spin 1s linear infinite;
			margin-left: 0.5rem;
			vertical-align: middle;
		}

		@keyframes spin {
			0% {
				transform: rotate(0deg);
			}

			100% {
				transform: rotate(360deg);
			}
		}

		/* Terminal Styles */
		#terminal {
			position: fixed;
			bottom: 0;
			left: 0;
			right: 0;
			background-color: #000;
			color: #0f0;
			padding: 0;
			border-radius: 0;
			overflow: hidden;
			z-index: 1000;
			box-shadow: 0 -4px 6px rgba(0, 0, 0, 0.1);
			height: 400px;
			min-height: 200px;
			max-height: 80vh;
			display: flex;
			flex-direction: column;
			animation: slideUp 0.3s ease-out;
		}

		/* Custom resize handle at the top */
		#terminal-resize-handle {
			height: 8px;
			background: linear-gradient(to bottom, #0f0, #008800);
			cursor: ns-resize;
			position: relative;
			flex-shrink: 0;
		}

		#terminal-resize-handle:hover {
			background: linear-gradient(to bottom, #00ff00, #00aa00);
			height: 10px;
		}

		/* Add visual indicator for drag handle */
		#terminal-resize-handle::before {
			content: 'â‹®â‹®â‹®';
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			color: #000;
			font-size: 8px;
			letter-spacing: 2px;
			opacity: 0.6;
		}

		/* Terminal content area */
		#terminal-body {
			flex: 1;
			padding: 20px;
			overflow: hidden;
			display: flex;
			flex-direction: column;
		}

		@keyframes slideUp {
			from {
				transform: translateY(100%);
			}
			to {
				transform: translateY(0);
			}
		}

		#terminal.hidden {
			display: none !important;
		}

		#terminal h3 {
			color: #fff;
			margin-top: 0;
			margin-bottom: 15px;
			flex-shrink: 0;
			font-family: 'Courier New', monospace;
			font-size: 16px;
			text-shadow: 0 0 5px #0f0;
			position: relative;
		}

		#terminal-content {
			font-family: 'Courier New', monospace;
			font-size: 14px;
			line-height: 1.4;
			white-space: pre-wrap;
			flex-grow: 1;
			overflow-y: auto;
			background-color: #000;
			padding: 10px;
			border: 1px solid #333;
			border-radius: 4px;
			scrollbar-width: thin;
			scrollbar-color: #0f0 #000;
		}

		#terminal-content::-webkit-scrollbar {
			width: 8px;
		}

		#terminal-content::-webkit-scrollbar-track {
			background: #000;
		}

		#terminal-content::-webkit-scrollbar-thumb {
			background: #0f0;
			border-radius: 4px;
		}

		#terminal-content::-webkit-scrollbar-thumb:hover {
			background: #00ff00aa;
		}

		#close-terminal {
			position: absolute;
			top: 14px;
			right: 15px;
			background-color: #f44336;
			color: white;
			border: none;
			padding: 8px 12px;
			cursor: pointer;
			flex-shrink: 0;
			border-radius: 4px;
			font-size: 12px;
			font-weight: bold;
			transition: background-color 0.2s;
		}

		#close-terminal:hover {
			background-color: #d32f2f;
		}

		#scroll-to-bottom {
			position: absolute;
			bottom: 20px;
			right: 20px;
			background-color: var(--primary-color);
			color: white;
			border: none;
			padding: 8px 16px;
			border-radius: 20px;
			font-size: 12px;
			cursor: pointer;
			box-shadow: 0 2px 8px rgba(157, 92, 255, 0.3);
			transition: all 0.3s ease;
			animation: bounce 1s infinite;
		}

		#scroll-to-bottom:hover {
			background-color: var(--secondary-color);
			transform: translateY(-2px);
		}

		#scroll-to-bottom.hidden {
			display: none !important;
		}

		@keyframes bounce {
			0%, 20%, 50%, 80%, 100% {
				transform: translateY(0);
			}
			40% {
				transform: translateY(-5px);
			}
			60% {
				transform: translateY(-3px);
			}
		}

		/* Floating terminal open button */
		#open-terminal {
			position: fixed;
			bottom: 20px;
			right: 20px;
			background-color: var(--primary-color);
			color: white;
			border: none;
			padding: 12px 20px;
			border-radius: 25px;
			font-size: 14px;
			font-weight: bold;
			cursor: pointer;
			box-shadow: 0 4px 12px rgba(157, 92, 255, 0.3);
			transition: all 0.3s ease;
			z-index: 999;
			animation: pulse 2s infinite;
		}

		#open-terminal:hover {
			background-color: var(--secondary-color);
			transform: translateY(-2px);
			box-shadow: 0 6px 16px rgba(157, 92, 255, 0.4);
		}

		#open-terminal.hidden {
			display: none !important;
		}

		@keyframes pulse {
			0% {
				box-shadow: 0 4px 12px rgba(157, 92, 255, 0.3);
			}
			50% {
				box-shadow: 0 4px 20px rgba(157, 92, 255, 0.5);
			}
			100% {
				box-shadow: 0 4px 12px rgba(157, 92, 255, 0.3);
			}
		}

		h2,
		h3 {
			color: var(--primary-color);
			font-weight: 600;
		}

		h2 {
			font-size: 2em;
		}

		/* Terminal typing effect for new messages */
		.terminal-line {
			opacity: 0;
			animation: fadeIn 0.2s ease-in forwards;
		}

		@keyframes fadeIn {
			to {
				opacity: 1;
			}
		}
	</style>
</head>

<body>
	<div class="title-bar">
		<svg class="logo"
			viewBox="0 0 100 100"
			xmlns="http://www.w3.org/2000/svg">
			<circle cx="50"
				cy="50"
				r="45"
				fill="#9d5cff" />
			<circle cx="35"
				cy="40"
				r="5"
				fill="#ffffff" />
			<circle cx="65"
				cy="40"
				r="5"
				fill="#ffffff" />
			<path d="M 30 70 Q 50 80 70 70"
				stroke="#ffffff"
				stroke-width="3"
				fill="none" />
			<rect x="20"
				y="15"
				width="10"
				height="20"
				rx="2"
				fill="#ffffff"
				transform="rotate(-15 25 25)" />
			<rect x="70"
				y="15"
				width="10"
				height="20"
				rx="2"
				fill="#ffffff"
				transform="rotate(15 75 25)" />
		</svg>
		<h1 class="title">Replay Simulator</h1>
	</div>
	<div class="container">
		<div class="form-container">
			<p id="form-description-line1">give me a URL + project token...</p>
			<p id="form-description-line2">...i'll give you replays!</p>
			<form id="simulatorForm">
				<label for="url">URL:</label>
				<input type="text"
					id="url"
					name="url"
					required>

				<label for="token">Mixpanel Token:</label>
				<input type="text"
					value="7c02ad22ae575ab4e15cdd052cd730fb"
					id="token"
					name="token"
					required>
				<a href="https://mixpanel.com/project/3276012/view/3782804/app/events"
					target="_blank"
					style="float: right; margin-left: auto; ">default project</a>

				<label for="users">Number of Users (1-25):</label>
				<input type="range"
					id="users"
					name="users"
					min="1"
					max="25"
					value="1">
				<output for="users"
					id="usersOutput">1</output>

				<!-- New Checkbox for Inject -->
				<label>
					<input type="checkbox"
						id="inject"
						name="inject"
						checked> Inject Mixpanel
				</label>

				<!-- New Checkbox for Headless -->
				<label>
					<input type="checkbox"
						id="headless"
						name="headless"
						checked> Run in Headless Mode
				</label>

				<!-- New Checkbox for Past -->
				<label>
					<input type="checkbox"
						id="past"
						name="past"> Simulate time in past
				</label>

				<button type="submit">lets go!</button>
			</form>
			<div class="loading">Simulating...</div>
			<div class="success"><br/>Your simulation is running!<br/>Check out your project!</div>
		</div>
	</div>

	<!-- TERMINAL -->
	<div id="terminal" class="hidden">
		<div id="terminal-resize-handle"></div>
		<div id="terminal-body">
			<h3>ðŸ›¬ Terminal Output</h3>
			<button id="close-terminal">âˆ’</button>
			<div id="terminal-content"></div>
			<button id="scroll-to-bottom" class="hidden">â†“ New messages</button>
		</div>
	</div>

	<!-- FLOATING TERMINAL OPEN BUTTON -->
	<button id="open-terminal" class="hidden">
		ðŸ“Ÿ Show Terminal
	</button>

	<script src="https://cdn.socket.io/4.8.1/socket.io.min.js"
		integrity="sha384-mkQ3/7FUtcGyoppY6bz/PORYoGqOl7/aSUMn2ymDOJcapfS6PHqxhRTMh1RR0Q6+"
		crossorigin="anonymous"></script>
	<script>
		const form = document.getElementById('simulatorForm');
		const loading = document.querySelector('.loading');
		const success = document.querySelector('.success');
		const usersSlider = document.getElementById('users');
		const usersOutput = document.getElementById('usersOutput');
		const url = document.getElementById('url');
		const formLine1 = document.getElementById('form-description-line1');
		const formLine2 = document.getElementById('form-description-line2');
		const possibleUrls = [
			"https://reddit.com",
			"https://youtube.com",
			"https://soundcloud.com",
			"https://tumblr.com",
			"https://bsky.app",
			"https://threads.net",
			"https://news.google.com/",
			"https://news.ycombinator.com/",
			"https://quora.com",
			"https://medium.com",
			"https://dev.to",
			"https://github.com",
			"https://stackoverflow.com",
			"https://nytimes.com",
			"https://washingtonpost.com",
			"https://bbc.com",
			"https://theverge.com",
			"https://techcrunch.com",
			"https://producthunt.com",
			"https://npr.org",
			"https://coinmarketcap.com",
			"https://cnn.com",
			"https://reuters.com",
			"https://apnews.com",
			"https://cnbc.com",
			"https://forbes.com",
			"https://bloomberg.com",
			"https://businessinsider.com",
			"https://arstechnica.com",
			"https://wired.com",
			"https://engadget.com",
			"https://zdnet.com",
			"https://slashdot.org",
			"https://huffpost.com",
			"https://vox.com",
			"https://vice.com",
			"https://polygon.com",
			"https://kotaku.com",
			"https://ign.com",
			"https://gamespot.com",
			"https://howtogeek.com",
			"https://lifewire.com",
			"https://digitaltrends.com",
			"https://tomshardware.com",
			"https://pcmag.com",
			"https://gizmodo.com",
			"https://cnet.com",
			"https://makeuseof.com",
			"https://tutorialspoint.com",
			"https://w3schools.com",
			"https://codecademy.com",
			"https://freecodecamp.org",
			"https://khanacademy.org",
			"https://nature.com",
			"https://sciencedaily.com",
			"https://livescience.com",
			"https://space.com",
			"https://nationalgeographic.com",
			"https://smithsonianmag.com",
			"https://history.com",
			"https://biography.com",
			"https://mentalfloss.com",
			"https://theatlantic.com",
			"https://economist.com",
			"https://marketwatch.com",
			"https://investopedia.com",
			"https://cryptoslate.com",
			"https://coindesk.com"
		];
		url.value = possibleUrls[Math.floor(Math.random() * possibleUrls.length)];

		usersSlider.addEventListener('input', (e) => {
			usersOutput.textContent = e.target.value;
		});

		// Terminal utility functions
		function addTerminalLine(content, message) {
			const timestamp = new Date().toLocaleTimeString();
			const line = document.createElement('div');
			line.className = 'terminal-line';
			line.innerHTML = `<span style="color: #666;">[${timestamp}]</span> ${message}`;
			
			// Check if user is already at the bottom (within 50px threshold)
			const isAtBottom = (content.scrollTop + content.clientHeight) >= (content.scrollHeight - 50);
			
			content.appendChild(line);
			
			// Only auto-scroll if user was already at the bottom
			if (isAtBottom) {
				content.scrollTop = content.scrollHeight;
				// Hide scroll-to-bottom button if it was showing
				const scrollButton = document.getElementById('scroll-to-bottom');
				if (scrollButton) scrollButton.classList.add('hidden');
			} else {
				// Show scroll-to-bottom button if user is scrolled up
				const scrollButton = document.getElementById('scroll-to-bottom');
				if (scrollButton) scrollButton.classList.remove('hidden');
			}
		}

		function clearTerminal(content) {
			content.innerHTML = '';
		}

		form.addEventListener('submit', async (e) => {
			e.preventDefault();
			const formData = new FormData(form);
			const data = Object.fromEntries(formData.entries());
			data.safeWord = "let me in...";			
			data.users = parseInt(data.users);
			data.concurrency = data.users;
			if (data.concurrency > 10) data.concurrency = 10;

			// Ensure checkbox values are included in the data
			data.inject = form.querySelector('#inject').checked;
			data.headless = form.querySelector('#headless').checked;
			data.past = form.querySelector('#past').checked;

			// Show terminal with animation
			const terminal = document.getElementById('terminal');
			const terminalContent = document.getElementById('terminal-content');
			
			// Add session separator if there's existing content
			if (terminalContent.children.length > 0) {
				addTerminalLine(terminalContent, '');
				addTerminalLine(terminalContent, 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
				addTerminalLine(terminalContent, 'ðŸ”„ NEW SIMULATION SESSION');
				addTerminalLine(terminalContent, 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
				addTerminalLine(terminalContent, '');
			}
			
			// Show terminal and hide open button
			terminal.classList.remove('hidden');
			openTerminalButton.classList.add('hidden');
			addTerminalLine(terminalContent, 'ðŸ”Œ Connecting to server...');

			// Connect to WebSocket (same server for Cloud Run)
			const socket = io();

			socket.on('connect', () => {
				addTerminalLine(terminalContent, 'âœ… Connected to server. Sending data...');
				socket.emit('start_job', data);
				loading.style.display = 'none';
			});

			socket.on('job_update', (message) => {
				// Handle multiple lines in a single message
				const lines = message.split('\n').filter(line => line.trim());
				lines.forEach(line => {
					if (line.trim()) {
						addTerminalLine(terminalContent, line);
					}
				});
			});

			socket.on('job_complete', (result) => {
				addTerminalLine(terminalContent, '');
				addTerminalLine(terminalContent, 'ðŸŽ‰ Simulation completed successfully!');
				addTerminalLine(terminalContent, 'ðŸ“Š Check your Mixpanel project for results');
				
				// Auto-close terminal after 3 seconds
				setTimeout(() => {
					if (!terminal.classList.contains('hidden')) {
						addTerminalLine(terminalContent, 'â±ï¸  Closing terminal in 10 seconds...');
					}
				}, 10_000);
				
				setTimeout(() => {
					terminal.classList.add('hidden');
					openTerminalButton.classList.remove('hidden');
					
					// Restore original form text
					formLine1.textContent = 'give me a URL + project token...';
					formLine2.textContent = '...i\'ll give you replays!';
					
					form.style.display = 'flex';
					loading.style.display = 'none';
				}, 5000);
				
				socket.disconnect();
			});

			socket.on('error', (error) => {
				addTerminalLine(terminalContent, `âŒ Error: ${error}`);
				socket.disconnect();
			});

			socket.on('disconnect', () => {
				addTerminalLine(terminalContent, 'ðŸ”Œ Disconnected from server');
			});

			// Update form text to show in progress
			formLine1.textContent = 'replays in progress...';
			formLine2.textContent = 'check the terminal below!';
			
			// Hide form inputs but keep the description visible
			form.style.display = 'none';
			loading.style.display = 'block';
		});

		// Minimize terminal (close button)
		const closeTerminalButton = document.getElementById('close-terminal');
		const openTerminalButton = document.getElementById('open-terminal');
		
		closeTerminalButton.addEventListener('click', () => {
			const terminal = document.getElementById('terminal');
			
			// Add exit animation
			terminal.style.animation = 'slideDown 0.3s ease-in forwards';
			
			setTimeout(() => {
				terminal.classList.add('hidden');
				terminal.style.animation = ''; // Reset animation
				// Show the floating open button
				openTerminalButton.classList.remove('hidden');
			}, 300);
		});

		// Open/expand terminal
		openTerminalButton.addEventListener('click', () => {
			const terminal = document.getElementById('terminal');
			
			// Hide the floating button
			openTerminalButton.classList.add('hidden');
			
			// Show terminal with animation
			terminal.classList.remove('hidden');
		});

		// Scroll-to-bottom functionality
		const scrollToBottomButton = document.getElementById('scroll-to-bottom');
		const terminalContent = document.getElementById('terminal-content');
		
		scrollToBottomButton.addEventListener('click', () => {
			terminalContent.scrollTop = terminalContent.scrollHeight;
			scrollToBottomButton.classList.add('hidden');
		});

		// Listen for manual scrolling to hide/show the scroll-to-bottom button
		terminalContent.addEventListener('scroll', () => {
			const isAtBottom = (terminalContent.scrollTop + terminalContent.clientHeight) >= (terminalContent.scrollHeight - 50);
			if (isAtBottom) {
				scrollToBottomButton.classList.add('hidden');
			}
			// Note: We don't show the button on scroll up here - only when new messages arrive
		});

		// Terminal resize functionality
		const resizeHandle = document.getElementById('terminal-resize-handle');
		const terminal = document.getElementById('terminal');
		
		let isResizing = false;
		let startY = 0;
		let startHeight = 0;

		resizeHandle.addEventListener('mousedown', (e) => {
			isResizing = true;
			startY = e.clientY;
			startHeight = parseInt(document.defaultView.getComputedStyle(terminal).height, 10);
			document.body.style.userSelect = 'none'; // Prevent text selection while dragging
			e.preventDefault();
		});

		document.addEventListener('mousemove', (e) => {
			if (!isResizing) return;

			const dy = startY - e.clientY; // Inverted because we're dragging from top
			let newHeight = startHeight + dy;
			
			// Apply constraints
			const minHeight = 200;
			const maxHeight = window.innerHeight * 0.8;
			newHeight = Math.max(minHeight, Math.min(maxHeight, newHeight));
			
			terminal.style.height = newHeight + 'px';
		});

		document.addEventListener('mouseup', () => {
			if (isResizing) {
				isResizing = false;
				document.body.style.userSelect = ''; // Re-enable text selection
			}
		});

		// Add slide down animation for close
		const slideDownCSS = `
			@keyframes slideDown {
				from {
					transform: translateY(0);
				}
				to {
					transform: translateY(100%);
				}
			}
		`;
		const style = document.createElement('style');
		style.textContent = slideDownCSS;
		document.head.appendChild(style);
	</script>
</body>

</html>